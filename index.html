<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>puuush</title>
    <script type="text/javascript" src="./js/jsgif/LZWEncoder.js"></script>
    <script type="text/javascript" src="./js/jsgif/NeuQuant.js"></script>
    <script type="text/javascript" src="./js/jsgif/GIFEncoder.js"></script>
    <script type="text/javascript" src="./js/jsgif/b64.js"></script>
    <script src='./js/util.js'></script>
    <script src='./js/game.js'></script>
    <script src='./js/ui.js'></script>
    <script>
    'use strict';
    var cur_state;

    function $(id) {
        return document.getElementById(id);
    }

    function redraw_text() {
        $('game_text').innerText = ui_state_to_text(cur_state)
    }

    function redraw_canvas() {
        ui_redraw_canvas($('game_canvas'), cur_state);
    }

    function redraw() {
        redraw_text();
        redraw_canvas();
        if (gif !== undefined)
            gif.addFrame($('game_canvas').getContext('2d'));
    }

    function start_game() {
        $('start_button').blur();
        var form = $('level');

        try {
            var map_details = ui_parse_map(form.elements.map.value);
        } catch (e) {
            alert(e);
            return;
        }

        var level = {
            height: map_details.height,
            width: map_details.width,
            starting_map: map_details.map,
            start_y: map_details.start_y,
            start_x: map_details.start_x,
            rules: {
                push_strength: parseStrength(form.elements.push_strength.value),
                pull_strength: parseStrength(form.elements.pull_strength.value),
                purp_strength: parseStrength(form.elements.purp_strength.value),
                push_slide: parseInt(form.elements.push_slide.value),
                pull_slide: parseInt(form.elements.pull_slide.value),
                purp_slide: parseInt(form.elements.purp_slide.value),
                simple_path: form.elements.simple_path.checked,
                gravity: form.elements.gravity.checked,
            }
        }

        if ((level.rules.pull_strength !== 0) && (level.rules.simple_path)) {
            alert('cannot enable falling blocks when pulling is also enabled');
            return;
        }

        cur_state = game_new_game(level);

        location.hash = '#' + util_serialize_form(form);

        ui_resize_canvas($('game_canvas'), cur_state);
        redraw();
    }

    function parseStrength(s) {
        var x = parseInt(s);
        return x >= 0 ? x : Infinity;
    }

    function init() {
        ui_preload_canvas_tiles();

        if (location.hash !== '' && location.hash[0] === '#') {
            try {
                util_deserialize_form($('level'), location.hash.substr(1));
            } catch (e) {
                console.log('Error parsing the hash string:');
                console.log(e);
            }
        }

        var pressed_keys = {};
        document.addEventListener('keydown', function (e) {
            pressed_keys[e.code] = true;
            $('is_pull').checked = e.shiftKey;
            $('is_purp').checked = pressed_keys['Space'] || pressed_keys['KeyP'];

            switch (e.code) {
                case 'KeyW':
                case 'ArrowUp':
                    move(-1, 0);
                break;
                case 'KeyA':
                case 'ArrowLeft':
                    move(0, -1);
                break;
                case 'KeyS':
                case 'ArrowDown':
                    move(1, 0);
                break;
                case 'KeyD':
                case 'ArrowRight':
                    move(0, 1);
                break;
            }
        });
        document.addEventListener('keyup', function (e) {
            pressed_keys[e.code] = false;
            $('is_pull').checked = e.shiftKey;
            $('is_purp').checked = pressed_keys['Space'] || pressed_keys['KeyP'];
        });
        start_game();
    }

    function move(dy, dx) {
        game_move(cur_state, $('is_pull').checked, $('is_purp').checked, dy, dx);
        redraw();
    }

    var gif = undefined;
    function record_gif() {
        if (gif === undefined) {
            // start gif
            gif = new GIFEncoder();
            gif.setRepeat(0);
            gif.setDelay(200);
            gif.start();
            gif.addFrame($('game_canvas').getContext('2d'));
            $('gif_button').innerText = 'Stop Recording';
            $('gif_button').blur();
        }
        else {
            // stop gif
            gif.addFrame($('game_canvas').getContext('2d'));
            gif.finish();
            var binary_gif = gif.stream().getData();
            var data_url = 'data:image/gif;base64,'+encode64(binary_gif);
            $('gif_output').src = data_url;
            $('gif_button').innerText = 'Record GIF';
            $('gif_button').blur();
            gif = undefined;
        }
    }
    </script>
    <style>
tt {
    border: 1px solid black;
    background: #ddd;
    padding: 2px;
}

div,textarea {
    margin-bottom: 7px;
}

.credits {
    margin-top: 5px;
    font-size: smaller;
}
    </style>
</head>
<body onload='init()'>
    <div>
        <form id='level'>
            <label>
                <div>Level geometry: (<tt>.</tt> for blank space, <tt>#</tt> for fixed blocks, <tt>x</tt> for movable blocks, <tt>S</tt> for start position, <tt>F</tt> for finish)</div>
                <textarea name='map' rows='5' cols='30' id=''>
.....xx.............
.................xxx
..S..............x.F
..................xx
..x.xx.xxx.xxxx...#.
                </textarea>
            </label>
            <div><label>Push strength: <input type='number' min='-1' value='1' length='3' name='push_strength'> (0 to disable, -1 for infinity)</label></div>
            <div>Push sliding behavior:
                <label><input type='radio' name='push_slide' value='0' checked
                    onclick="fix_gravity_button()"> no sliding</label>,
                <label><input type='radio' name='push_slide' value='1'> moved blocks slide</label>
                <label><input type='radio' name='push_slide' value='2'> all blocks in path slide</label>.
            </div>
            <div><label>Pull strength: <input type='number' min='-1' value='1' length='3' name='pull_strength'> (0 to disable, -1 for infinity)</label></div>
            <div>Pull sliding behavior:
                <label><input type='radio' name='pull_slide' value='0' checked
                    onclick="fix_gravity_button()"> no sliding</label>,
                <label><input type='radio' name='pull_slide' value='1' disabled> moved blocks slide</label>
                <label><input type='radio' name='pull_slide' value='2' disabled> all blocks in path slide</label>.
            </div>
            <div><label>Purp strength: <input type='number' min='-1' value='1' length='3' name='purp_strength'> (0 to disable, -1 for infinity)</label></div>
            <div>Purp sliding behavior:
                <label><input type='radio' name='purp_slide' value='0' checked
                    onclick="fix_gravity_button()"> no sliding</label>,
                <label><input type='radio' name='purp_slide' value='1'> moved blocks slide</label>
                <label><input type='radio' name='purp_slide' value='2'> all blocks in path slide</label>.
            </div>
            <div>
                <label><input type='checkbox' name='simple_path'> Visited blocks fall</label>
                <label><input type='checkbox' name='gravity'> Gravity</label>
            </div>
            <button type='button' id='start_button' onclick='start_game()'>start</button>
        </form>
    </div>
    <hr>
    <div>
        Move:
        <button onclick='move(0, -1)'>←</button>
        <button onclick='move(1, 0)'>↓</button>
        <button onclick='move(-1, 0)'>↑</button>
        <button onclick='move(0, 1)'>→</button>
        (WASD or arrow keys)
    </div>
    <div>
        <input type='checkbox' id='is_pull'> Pull (Shift)</label>
    </div>
    <div>
        <input type='checkbox' id='is_purp'> Purp (Space or P)</label>
    </div>
    <canvas id='game_canvas'></canvas>
    <pre id='game_text'></pre>
    <button type='button' id='gif_button' onclick='record_gif()'>Record GIF</button>
    <div><img id='gif_output' /></div>
    <div class='credits'>penguin icon by <a href='https://icons8.com' rel='noreferrer'>icons8.com</a>, thanks!</div>
    <div class='credits'>GIF recorder powered by <a href='https://github.com/antimatter15/jsgif'>jsgif</a>.</div>
</body>
</html>

<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>puuush</title>
    <script src='./js/util.js'></script>
    <script src='./js/game.js'></script>
    <script src='./js/ui.js'></script>
    <script>
    var cur_state;
    function redraw() {
        document.getElementById('game').innerText = ui_state_to_text(cur_state)
    }

    function start_game() {
        var form = document.getElementById('level');

        try {
            var map_details = ui_parse_map(form.elements.map.value);
        } catch (e) {
            alert(e);
            return;
        }

        var level = {
            height: map_details.height,
            width: map_details.width,
            starting_map: map_details.map,
            start_y: map_details.start_y,
            start_x: map_details.start_x,
            rules: {
                push_strength: parseInt(form.elements.push_strength.value),
                pull_strength: parseInt(form.elements.pull_strength.value),
                push_slide: parseInt(form.elements.push_slide.value),
                simple_path: form.elements.simple_path.checked,
            }
        }

        if ((level.rules.pull_strength !== 0) && (level.rules.simple_path)) {
            alert('cannot enable falling blocks when pulling is also enabled');
            return;
        }

        cur_state = game_new_game(level);
        redraw();
    }

    function init() {
        document.addEventListener('keypress', function (e) {
            var is_pull = e.shiftKey;
            switch (e.code) {
                case 'KeyW':
                    move(is_pull, -1, 0);
                break;
                case 'KeyA':
                    move(is_pull, 0, -1);
                break;
                case 'KeyS':
                    move(is_pull, 1, 0);
                break;
                case 'KeyD':
                    move(is_pull, 0, 1);
                break;
            }
        });
    }

    function move(is_pull, dy, dx) {
        game_move(cur_state, is_pull, dy, dx);
        redraw();
    }
    </script>
</head>
<body onload='init()'>
    <div>
        <form id='level'>
            <div>
                <label>Level geometry: (<tt>.</tt> for blank space, <tt>#</tt> for fixed blocks, <tt>x</tt> for movable blocks, <tt>S</tt> for start position, <tt>F</tt> for finish)<br>
                <textarea name='map' rows='5' cols='30' id=''>
.....xx.............
.................xxx
..S..............x.F
..................xx
..x.xx.xxx.xxxx...#.
                </textarea>
                </label>
            </div>
            <div><label>Push strength: <input type='number' min='-1' value='2' length='3' name='push_strength'> (0 to disable, -1 for infinity)</label></div>
            <div>Push sliding behavior:
                <label><input type='radio' name='push_slide' value='0' checked> no sliding</label>,
                <label><input type='radio' name='push_slide' value='1'> moved blocks slide</label>
                <label><input type='radio' name='push_slide' value='2'> all blocks in path slide</label>.
            </div>
            <div><label>Pull strength: <input type='number' min='-1' value='0' length='3' name='pull_strength'> (0 to disable, -1 for infinity)</label></div>
            <div><label><input type='checkbox' name='simple_path'> Visited blocks fall</label></div>
            <button type='button' onclick='start_game()'>start</button>
        </form>
    </div>
    <hr>
    <div>
        push:
        <button onclick='move(false, 0, -1)'>←</button>
        <button onclick='move(false, 1, 0)'>↓</button>
        <button onclick='move(false, -1, 0)'>↑</button>
        <button onclick='move(false, 0, 1)'>→</button>
        (or WASD)
    </div>
    <div>
        pull:
        <button onclick='move(true, 0, -1)'>←</button>
        <button onclick='move(true, 1, 0)'>↓</button>
        <button onclick='move(true, -1, 0)'>↑</button>
        <button onclick='move(true, 0, 1)'>→</button>
        (or Shift+WASD)
    </div>
    <pre id='game'></pre>
</body>
</html>
